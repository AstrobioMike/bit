# bit-cov-analyzer


# want to generate coverage stats for a given (sliding) window size across an assembly when given the
    # assembly and the "*regions.bed.gz" mosdepth produces, though maybe running mosdepth
    # will be the way to go, given a bam file, as i think i can specify the window size there instead
    # of doing it myself


# then generate coverage stats for the windows like: percentile, z-score ((x – μ) / σ), and fold-change (x / μ)

# return regions (contigs and coordinates) and seqs for everything above some threshold (likely
    # fold-change as it's probably the most intuitive)


## more defined process ##
# mosdepth can only do fixed windows, so doing smaller window than i want (50), and then averaging over 500bp sets of
    # 10 to get a "rolling window" of 500bp pieces every 50bp step
    # but will need to run mosdepth, so will need reference and input bam (and indexed bam)

bit-cov-analyzer -r mock.fasta -b mock.bam
    # if no mock.bam.bai, run samtools index mock.bam
# mosdepth --by 100 mock mock.bam
# take ref fasta and mock.regions.bed.gz file and combine them to make a full tiled-window bed that has 0s as needed
# generate stats on this per sliding window across 1kb sections of the 100bp average coverages (percentile, z-score, fold-change)
# summarize all that in a table, maybe all windows (labeled in first column) ordered by highest fold-change to lowest
# decide what regions to pull out based on threshold, maybe fold-change or z-score, and parse out those regions from the fasta
# bob's your uncle


## making small test data with 10X higher coverage in one area

# getting a genome
wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/000/005/845/GCF_000005845.2_ASM584v2/GCF_000005845.2_ASM584v2_genomic.fna.gz

gunzip GCF_000005845.2_ASM584v2_genomic.fna.gz

# making 2 small contigs
head -n 6001 GCF_000005845.2_ASM584v2_genomic.fna | tail -n +2 > mock-c1.fa
sed -n '6002,12001p' GCF_000005845.2_ASM584v2_genomic.fna > mock-c2.fa
    # manually added headers
cat mock-c1.fa mock-c2.fa > mock.fasta

# making a 2000 bp region of one of those to make higher coverage for
sed -n '2000,2024p' mock.fasta > higher-region.fasta
    # manually added a header

rm GCF_000005845.2_ASM584v2_genomic.fna mock-c1.fa mock-c2.fa

# making reads
bit-gen-reads -i mock.fasta -n 64000 -o initial-reads
bit-gen-reads -i higher-region.fasta -n 1400 -o higher-cov-reads

cat initial-reads_R1.fastq.gz higher-cov-reads_R1.fastq.gz > mock-reads-R1.fq.gz
cat initial-reads_R2.fastq.gz higher-cov-reads_R2.fastq.gz > mock-reads-R2.fq.gz

rm initial-reads_R* higher-cov-reads_R*

# mapping
cda magrec-mapping

bowtie2-build mock.fasta mock
bowtie2 -x mock -1 mock-reads-R1.fq.gz -2 mock-reads-R2.fq.gz | samtools view -b | samtools sort -o mock.bam
samtools index mock.bam

cda bit
mosdepth --by 100 100 mock.bam

